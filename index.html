<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anonim Sohbet</title>
  <style>
    body{margin:0;font-family:"Courier New",monospace;background:#000;color:#eee}
    .menubar{display:flex;justify-content:space-between;align-items:center;background:#111;padding:6px;border-bottom:1px solid #333}
    .menubar button{background:#222;border:1px solid #444;color:#eee;padding:4px 10px;cursor:pointer;margin-right:4px}
    .layout{display:grid;grid-template-columns:240px 1fr 220px;height:calc(100vh - 38px)}
    .pane{background:#111;border-right:1px solid #333;display:flex;flex-direction:column}
    .pane-right{border-left:1px solid #333}
    .pane-title{padding:6px;font-weight:bold;border-bottom:1px solid #333}
    .list{list-style:none;margin:0;padding:6px;overflow:auto}
    .list li{padding:4px 6px;display:flex;gap:6px;align-items:center;justify-content:space-between}
    .list li span.item{flex:1;cursor:pointer}
    .list li.active{background:#1b1b1b}
    .deleteBtn,.dmBtn{background:none;border:1px solid #444;color:#eee;cursor:pointer;font-size:12px;padding:2px 6px}
    .center{display:flex;flex-direction:column}
    .topic{padding:6px;text-align:center;border-bottom:1px solid #333;color:#aaa}
    .messages{flex:1;overflow:auto;padding:6px;font-size:13px;background:#000}
    .message{margin:2px 0}
    .message .nick{font-weight:bold;margin-right:4px}
    .time{color:#888;font-size:11px;margin-right:6px}
    .info{color:#888;text-align:center;font-style:italic;margin:4px 0}
    .inputbar{display:flex;border-top:1px solid #333;background:#111}
    .inputbar input{flex:1;background:#000;color:#eee;border:1px solid #333;padding:6px}
    .inputbar button{background:#222;color:#eee;border:1px solid #333;padding:6px}

    /* Mobil uyum */
    @media(max-width:768px){
      .layout{grid-template-columns:1fr}
      .pane,.pane-right{display:none}
      .menubar .mobile-toggle{display:inline-block}
    }
    @media(min-width:769px){.menubar .mobile-toggle{display:none}}
    #mobileMenu{position:fixed;top:0;left:-260px;width:260px;height:100%;background:#111;border-right:1px solid #333;transition:left .3s;z-index:1000;padding:6px}
    #mobileMenu.open{left:0}
    #mobileMenu .closeBtn{background:#222;border:1px solid #444;color:#eee;width:100%;margin-bottom:8px;padding:6px;cursor:pointer}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal.open{display:flex}
    .modal-content{background:#111;padding:14px;border:1px solid #333;display:grid;gap:6px;min-width:280px}
    .modal-content input{background:#000;color:#eee;border:1px solid #333;padding:6px}
    .modal-actions{display:flex;gap:8px;margin-top:6px}
  </style>
</head>
<body>
  <div class="menubar">
    <button class="mobile-toggle" onclick="toggleMobileMenu()">‚ò∞ Men√º</button>
    <div>
      <button id="btnProfile">Profil</button>
      <button id="btnAddChannel">+ Kanal</button>
    </div>
  </div>

  <!-- Mobil Men√º -->
  <div id="mobileMenu">
    <button class="closeBtn" onclick="toggleMobileMenu()">‚úñ Kapat</button>
    <div class="pane-title">üîù Pop√ºler Kanallar</div><ul id="popularListMobile" class="list"></ul>
    <div class="pane-title">üë§ Benim Kanallarƒ±m</div><ul id="myListMobile" class="list"></ul>
    <div class="pane-title">Kullanƒ±cƒ±lar</div><ul id="userListMobile" class="list"></ul>
  </div>

  <div class="layout">
    <aside class="pane">
      <div class="pane-title">üîù Pop√ºler Kanallar</div><ul id="popularList" class="list"></ul>
      <div class="pane-title">üë§ Benim Kanallarƒ±m</div><ul id="myList" class="list"></ul>
    </aside>
    <main class="center">
      <div id="topic" class="topic">#genel ‚Äî 0 ki≈üi</div>
      <div id="messages" class="messages" id="messages"></div>
      <form id="form" class="inputbar"><input id="input" placeholder="Mesaj yaz..."/><button>G√∂nder</button></form>
    </main>
    <aside class="pane pane-right">
      <div class="pane-title">Kullanƒ±cƒ±lar</div><ul id="userList" class="list"></ul>
    </aside>
  </div>

  <!-- Kanal Modal -->
  <div id="addChannelModal" class="modal">
    <div class="modal-content">
      <h3>Yeni Kanal</h3>
      <input id="newChannelInput" placeholder="#kanal-adi"/>
      <div class="modal-actions">
        <button id="confirmAddChannel">Ekle</button>
        <button id="cancelAddChannel">ƒ∞ptal</button>
      </div>
    </div>
  </div>

  <!-- Profil Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <h3>Profil (Opsiyonel)</h3>
      <label>ƒ∞sim</label><input id="firstName"/>
      <label>Soyisim</label><input id="lastName"/>
      <label>Email</label><input id="email"/>
      <label>√úlke</label><input id="country"/>
      <label>≈ûehir</label><input id="city"/>
      <div class="modal-actions">
        <button id="saveProfile">Kaydet</button>
        <button id="skipProfile">Anonim</button>
      </div>
    </div>
  </div>

<script>
/* ---- Config & State ---- */
const WS_URL = "wss://chat-backend-1-iq7t.onrender.com";
let currentChannel = "#genel";
let usersInRoom = [];
let messagesByChannel = {};
let anonName = localStorage.getItem("anonName") || ("User" + Math.floor(Math.random()*1000));
localStorage.setItem("anonName", anonName);
let myChannels = JSON.parse(localStorage.getItem("myChannels") || "[]");
let profile = JSON.parse(localStorage.getItem("profile") || "{}");
let peerLabelInDM = null; // Topic'te DM partner ismi g√∂stermek i√ßin

/* ---- Helpers ---- */
function toggleMobileMenu(force){
  const el = document.getElementById("mobileMenu");
  if (force === false) { el.classList.remove("open"); return; }
  el.classList.toggle("open");
}
function formatTime(){ return new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"}); }
function formatFrom(nick, prof){ return (prof?.country && prof?.city) ? `${nick} (${prof.country}/${prof.city})` : nick; }
function addInfo(text){
  const div = document.createElement("div"); div.className="info"; div.textContent = text;
  messagesEl.appendChild(div); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function addMessage(from, text, cls){
  const row = document.createElement("div"); row.className="message "+cls;
  row.innerHTML = `<span class="time">[${formatTime()}]</span><span class="nick">${from}:</span> ${text}`;
  messagesEl.appendChild(row); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function updateTopic(){
  const base = peerLabelInDM ? `${currentChannel} ‚Äî ${peerLabelInDM}` : `${currentChannel} ‚Äî ${usersInRoom.length} ki≈üi`;
  topicEl.textContent = base;
}

/* ---- DOM ---- */
const popularListEl = document.getElementById("popularList");
const myListEl      = document.getElementById("myList");
const userListEl    = document.getElementById("userList");
const messagesEl    = document.getElementById("messages");
const topicEl       = document.getElementById("topic");
const form          = document.getElementById("form");
const input         = document.getElementById("input");

const popularListMobile = document.getElementById("popularListMobile");
const myListMobile      = document.getElementById("myListMobile");
const userListMobile    = document.getElementById("userListMobile");

/* ---- Renderers ---- */
function createChannelLi(ch, count){
  const li = document.createElement("li");
  const span = document.createElement("span"); span.className="item"; span.textContent = count!=null ? `${ch} (${count})` : ch;
  span.onclick = () => { switchChannel(ch); toggleMobileMenu(false); };
  li.appendChild(span);
  return li;
}
function createMyChannelLi(ch){
  const li = document.createElement("li");
  const span = document.createElement("span"); span.className="item"; span.textContent = ch;
  span.onclick = () => { switchChannel(ch); toggleMobileMenu(false); };
  const del = document.createElement("button"); del.className="deleteBtn"; del.textContent="‚ùå";
  del.onclick = (e)=>{ e.stopPropagation(); removeMyChannel(ch); };
  li.appendChild(span); li.appendChild(del); return li;
}
function renderPopular(stats){
  // DM odalarƒ±nƒ± zaten backend filtreliyor; yine de g√ºvenlik i√ßin bir kez daha filtreleyelim
  const list = (stats||[]).filter(s=>!String(s.channel).startsWith("@dm:")).sort((a,b)=>b.count-a.count).slice(0,5);
  popularListEl.innerHTML = ""; popularListMobile.innerHTML = "";
  list.forEach(s=>{
    const a = createChannelLi(s.channel, s.count);
    const b = createChannelLi(s.channel, s.count);
    popularListEl.appendChild(a); popularListMobile.appendChild(b);
  });
}
function renderMyChannels(){
  myListEl.innerHTML = ""; myListMobile.innerHTML = "";
  myChannels.forEach(ch=>{
    const a = createMyChannelLi(ch);
    const b = createMyChannelLi(ch);
    myListEl.appendChild(a); myListMobile.appendChild(b);
  });
}
function renderUsers(list){
  usersInRoom = list || [];
  userListEl.innerHTML = ""; userListMobile.innerHTML = "";
  (list||[]).forEach(u=>{
    const li = document.createElement("li");
    const span = document.createElement("span"); span.className="item"; span.textContent = u.display || u.nick;
    const dm = document.createElement("button"); dm.className="dmBtn"; dm.textContent = "DM";
    dm.onclick = (e)=>{ e.stopPropagation(); startDM(u.uid, u.display || u.nick); };
    li.appendChild(span); li.appendChild(dm);
    userListEl.appendChild(li);
    userListMobile.appendChild(li.cloneNode(true));
  });
  // DM partner etiketi yoksa ki≈üi sayƒ±sƒ±nƒ± g√∂ster
  if (!peerLabelInDM) updateTopic();
}

/* ---- Kanallarƒ±m ---- */
function addMyChannel(ch){
  if (!ch) return;
  if (!ch.startsWith("#") && !ch.startsWith("@dm:")) ch = "#"+ch;
  if (!myChannels.includes(ch)) {
    myChannels.push(ch);
    localStorage.setItem("myChannels", JSON.stringify(myChannels));
    renderMyChannels();
  }
}
function removeMyChannel(ch){
  myChannels = myChannels.filter(x=>x!==ch);
  localStorage.setItem("myChannels", JSON.stringify(myChannels));
  renderMyChannels();
}

/* ---- WS ---- */
let ws;
function connectWS(){
  ws = new WebSocket(WS_URL);
  ws.onopen = () => sendJoin(); // mevcut kanal ile katƒ±l
  ws.onmessage = (ev) => {
    let msg; try { msg = JSON.parse(ev.data); } catch { return; }
    if (msg.type === "info") addInfo(msg.message);
    if (msg.type === "users") { peerLabelInDM = currentChannel.startsWith("@dm:") ? (peerLabelInDM || "") : null; renderUsers(msg.users); }
    if (msg.type === "message") addMessage(msg.from, msg.text, "other");
    if (msg.type === "channels") renderPopular(msg.stats);
    if (msg.type === "dm-start") handleDMStart(msg);
  };
}
function sendJoin(){
  ws.send(JSON.stringify({
    type: "join",
    channel: currentChannel,
    nick: anonName,
    profile: { country: profile.country, city: profile.city }
  }));
}
function switchChannel(ch){
  currentChannel = ch;
  peerLabelInDM = ch.startsWith("@dm:") ? (peerLabelInDM || "√ñzel sohbet") : null;
  messagesEl.innerHTML = "";
  addInfo(`${ch} kanalƒ±na girdin.`);
  if (ws && ws.readyState === 1) sendJoin();
}

/* ---- DM ---- */
function startDM(toUid, label){
  if (!toUid) return;
  ws.send(JSON.stringify({ type: "dm", toUid }));
  // label'ƒ± topic'te g√∂stermek i√ßin sakla (server'dan da gelecek ama UX hƒ±zlƒ± olsun)
  peerLabelInDM = `√ñzel sohbet ‚Äî ${label}`;
}
function handleDMStart(msg){
  const { room, peer } = msg; // peer.display
  peerLabelInDM = `√ñzel sohbet ‚Äî ${peer.display}`;
  switchChannel(room);
  // DM odasƒ±nƒ± kanallarƒ±ma otomatik eklemek istersen:
  // addMyChannel(room);
}

/* ---- Events ---- */
form.onsubmit = (e) => {
  e.preventDefault();
  const text = input.value.trim();
  if (!text) return;
  addMessage(formatFrom(anonName, profile), text, "me");
  input.value = "";
  if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: "message", text }));
};

// Kanal modal
document.getElementById("btnAddChannel").onclick = () => addChannelModal.classList.add("open");
document.getElementById("confirmAddChannel").onclick = () => {
  const ch = newChannelInput.value.trim();
  if (ch) addMyChannel(ch);
  newChannelInput.value = "";
  addChannelModal.classList.remove("open");
};
document.getElementById("cancelAddChannel").onclick = () => addChannelModal.classList.remove("open");

// Profil modal
document.getElementById("btnProfile").onclick = () => profileModal.classList.add("open");
document.getElementById("saveProfile").onclick = () => {
  profile = {
    first: firstName.value, last: lastName.value, email: email.value,
    country: country.value, city: city.value
  };
  localStorage.setItem("profile", JSON.stringify(profile));
  profileModal.classList.remove("open");
  if (ws && ws.readyState === 1) sendJoin();
};
document.getElementById("skipProfile").onclick = () => profileModal.classList.remove("open");

/* ---- Ba≈ülat ---- */
renderMyChannels();
switchChannel(currentChannel);
connectWS();
</script>
</body>
</html>
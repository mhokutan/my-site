<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Anonim Sohbet</title>
  <style>
    body{margin:0;font-family:"Courier New",monospace;background:#000;color:#eee}
    .menubar{display:flex;justify-content:space-between;align-items:center;background:#111;padding:6px;border-bottom:1px solid #333}
    .menubar button{background:#222;border:1px solid #444;color:#eee;padding:4px 10px;cursor:pointer}
    .layout{display:grid;grid-template-columns:240px 1fr 220px;height:calc(100vh - 38px)}
    .pane{background:#111;border-right:1px solid #333;display:flex;flex-direction:column;min-height:0}
    .pane-right{border-left:1px solid #333}
    .pane-title{padding:6px;font-weight:bold;border-bottom:1px solid #333}
    .list{list-style:none;margin:0;padding:6px;overflow:auto}
    .list li{padding:4px 6px;display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none}
    .list li:hover{background:#0a0a0a}
    .list li.sponsor{color:#4af;font-weight:bold}
    .center{display:flex;flex-direction:column;min-height:0}
    .topic{padding:6px;text-align:center;border-bottom:1px solid #333;color:#aaa}
    .messages{flex:1;overflow:auto;padding:6px;font-size:13px;background:#000}
    .time{color:#888;font-size:11px;margin-right:6px}
    .info{color:#888;text-align:center;font-style:italic;margin:4px 0}
    .typing{color:#4af;font-size:12px;margin:2px 0;font-style:italic}
    .inputbar{display:flex;border-top:1px solid #333;background:#111;gap:6px;padding:6px}
    .inputbar input{flex:1;background:#000;color:#eee;border:1px solid #333;padding:6px}
    .inputbar button{background:#222;color:#eee;border:1px solid #333;padding:6px}
    .avatar{font-size:16px}
    .star{cursor:pointer;color:#666;margin-left:auto}
    .star.following{color:gold}
    .hint{color:#888;font-size:12px;padding:6px;border-top:1px solid #222}
    @media(max-width:768px){
      .layout{grid-template-columns:1fr}
      .pane,.pane-right{display:none}
      .menubar .mobile-toggle{display:inline-block}
      #mobileMenu{display:block;}
    }
    @media(min-width:769px){
      .menubar .mobile-toggle{display:none}
      #mobileMenu{display:none !important;}
    }
    #mobileMenu{
      position:fixed;top:0;left:-260px;width:260px;height:100%;
      background:#111;border-right:1px solid #333;
      transition:left .3s;z-index:1000;padding:6px
    }
    #mobileMenu.open{left:0}
    #mobileMenu .closeBtn{
      background:#222;border:1px solid #444;color:#eee;
      width:100%;margin-bottom:8px;padding:6px;cursor:pointer
    }
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal.open{display:flex}
    .modal-content{background:#111;padding:14px;border:1px solid #333;display:grid;gap:6px;min-width:300px;max-width:92vw;position:relative}
    .modal-content input,.modal-content select,.modal-content textarea{background:#000;color:#eee;border:1px solid #333;padding:6px}
    .modal-close{position:absolute;top:4px;right:4px;background:#222;color:#eee;border:1px solid #444;cursor:pointer;padding:2px 6px}
    .section{border-top:1px solid #222;margin-top:6px;padding-top:6px}
    .muted{color:#aaa;font-size:12px}
    /* === YENÄ°: Emoji picker konumlandÄ±rma === */
    #emojiBox{position:absolute;display:none;z-index:3000}
  </style>
  <!-- === YENÄ°: Emoji Picker KÃ¼tÃ¼phanesi === -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
</head>
<body>
  <div class="menubar">
    <button class="mobile-toggle" onclick="toggleMobileMenu()">â˜° MenÃ¼</button>
    <span id="authStatus">Anonim</span>
    <div>
      <!-- === YENÄ°: Ã–neri butonu === -->
      <button id="btnFeedback">Ã–neri</button>
      <button id="btnLogin">GiriÅŸ</button>
      <button id="btnProfile" style="display:none">Profil DÃ¼zenle</button>
      <button id="btnLogout" style="display:none">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </div>

  <div class="layout">
    <aside class="pane">
      <!-- ðŸ”· Sponsorlu Kanallar -->
      <div class="pane-title">Sponsorlu Kanallar</div>
      <ul id="sponsorList" class="list">
        <li class="sponsor" onclick="joinSponsor()">#heponsigorta</li>
      </ul>

      <div class="pane-title">Kanallar</div>
      <ul id="channelList" class="list"></ul>
      <div id="addChannelBox" style="display:none;padding:6px;border-top:1px solid #333">
        <input id="newChannel" placeholder="#kanal-adÄ±" style="width:100%;margin-bottom:4px"/>
        <button id="btnAddChannel" style="width:100%">Ekle</button>
        <div class="hint muted">Kendi kanalÄ±nÄ± ekle (#konya gibi). Varsa aynÄ± isimle eÅŸleÅŸir.</div>
      </div>
    </aside>

    <main class="center">
      <div id="topic" class="topic">#genel</div>
      <div id="messages" class="messages"></div>
      <div id="typingArea"></div>
      <form id="form" class="inputbar" autocomplete="off">
        <input id="input" placeholder="Mesaj yaz..." maxlength="1000"/>
        <button>GÃ¶nder</button>
        <!-- === YENÄ°: Emoji dÃ¼ÄŸmesi === -->
        <button type="button" id="btnEmoji" title="Emoji">ðŸ˜€</button>
      </form>
      <!-- === YENÄ°: Emoji picker kutusu === -->
      <emoji-picker id="emojiBox"></emoji-picker>
    </main>

    <aside class="pane pane-right">
      <div class="pane-title">KullanÄ±cÄ±lar</div>
      <ul id="userList" class="list"></ul>
      <div class="pane-title">Takip Ettiklerim</div>
      <ul id="followList" class="list"></ul>
    </aside>
  </div>

  <!-- ðŸ“± Mobil MenÃ¼ -->
  <div id="mobileMenu">
    <button class="closeBtn" onclick="toggleMobileMenu()">âœ– Kapat</button>

    <div class="pane-title">Sponsorlu Kanallar</div>
    <ul id="sponsorListMobile" class="list">
      <li class="sponsor" onclick="joinSponsor()">#heponsigorta</li>
    </ul>

    <div class="pane-title">Kanallar</div>
    <ul id="channelListMobile" class="list"></ul>
    <div id="addChannelBoxMobile" style="display:none;padding:6px;border-top:1px solid #333">
      <input id="newChannelMobile" placeholder="#kanal-adÄ±" style="width:100%;margin-bottom:4px"/>
      <button id="btnAddChannelMobile" style="width:100%">Ekle</button>
      <div class="hint muted">Kendi kanalÄ±nÄ± ekle (#konya gibi).</div>
    </div>

    <div class="pane-title">KullanÄ±cÄ±lar</div>
    <ul id="userListMobile" class="list"></ul>

    <div class="pane-title">Takip Ettiklerim</div>
    <ul id="followListMobile" class="list"></ul>

    <div class="pane-title">Hesap</div>
    <button onclick="btnLogin.click()">GiriÅŸ</button>
    <button onclick="btnProfile.click()">Profil DÃ¼zenle</button>
    <button onclick="btnLogout.click()">Ã‡Ä±kÄ±ÅŸ</button>
  </div>

  <!-- ðŸ” Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="loginModal.classList.remove('open')">âœ–</button>
      <h3>GiriÅŸ / KayÄ±t</h3>
      <input id="identifier" placeholder="Email veya Telefon"/>
      <input id="password" type="password" placeholder="Åžifre"/>
      <div class="section">
        <button id="doLogin">GiriÅŸ</button>
        <button id="doRegister">KayÄ±t</button>
      </div>
      <div class="muted">GiriÅŸ yapmadan anonim sohbet edebilirsin; fakat DM, arkadaÅŸ ekleme ve kanal ekleme iÃ§in giriÅŸ gerekir.</div>
    </div>
  </div>

  <!-- ðŸ‘¤ Profil Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="profileModal.classList.remove('open')">âœ–</button>
      <h3>Profil DÃ¼zenle</h3>
      <input id="firstName" placeholder="Ä°sim"/>
      <input id="lastName" placeholder="Soyisim"/>
      <select id="gender">
        <option value="">Cinsiyet</option>
        <option value="erkek">Erkek</option>
        <option value="kadÄ±n">KadÄ±n</option>
      </select>
      <input id="birth" placeholder="DoÄŸum Tarihi"/>
      <input id="country" placeholder="Ãœlke"/>
      <input id="city" placeholder="Åžehir"/>
      <button id="saveProfile">Kaydet</button>
      <div class="muted">Cinsiyete gÃ¶re avatar otomatik ayarlanÄ±r (ðŸ‘¨ / ðŸ‘©).</div>
      <!-- === YENÄ°: Hobiler butonu -->
      <div class="section">
        <button type="button" id="btnHobbies">Ä°lgi AlanlarÄ±</button>
      </div>
    </div>
  </div>

  <!-- === YENÄ°: Hobiler Modal === -->
  <div id="hobbyModal" class="modal">
    <div class="modal-content" style="max-height:70vh;overflow:auto">
      <button onclick="hobbyModal.classList.remove('open')" class="modal-close">âœ–</button>
      <h3>Ä°lgi AlanlarÄ±</h3>
      <div id="hobbyList"></div>
      <div style="margin-top:8px"><b>SeÃ§ilenler:</b> <span id="hobbyPicked"></span></div>
      <button id="saveHobbies">Kaydet</button>
      <div class="muted">SeÃ§tiklerine gÃ¶re Ã¶nerilen kanallar otomatik eklenecek.</div>
    </div>
  </div>

  <!-- === YENÄ°: Ã–neri / Feedback Modal === -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="feedbackModal.classList.remove('open')">âœ–</button>
      <h3>Ã–neri GÃ¶nder</h3>
      <textarea id="feedbackText" placeholder="Ã–nerini / isteÄŸini yaz..." style="width:60vw;max-width:600px;height:120px"></textarea>
      <div class="section">
        <button id="sendFeedback">GÃ¶nder</button>
      </div>
      <div class="muted">TeÅŸekkÃ¼rler! DÃ¼ÅŸÃ¼nceleriniz geliÅŸtirmemize yardÄ±mcÄ± olur.</div>
    </div>
  </div>

<script>
/* ===================== Config ===================== */
const API="https://chat-backend-1-iq7t.onrender.com";
const WS_URL="wss://chat-backend-1-iq7t.onrender.com";
let token=localStorage.getItem("token");
let ws,currentChannel="#genel";

/* ===================== UI Helpers ===================== */
const AVATARS={
  male:"<span class='avatar' style='color:#4af'>ðŸ‘¨</span>",
  female:"<span class='avatar' style='color:#f6a'>ðŸ‘©</span>",
  default:"<span class='avatar' style='color:#aaa'>ðŸ‘¤</span>"
};

let follows=JSON.parse(localStorage.getItem("follows")||"[]");
function saveFollows(){
  localStorage.setItem("follows",JSON.stringify(follows));
  renderFollows();
}

const bannedWords=["kÃ¼fÃ¼r1","kÃ¼fÃ¼r2","badword"];
function cleanMessage(text){
  let safe=text;
  bannedWords.forEach(w=>{
    const re=new RegExp(w,"gi");
    safe=safe.replace(re,"***");
  });
  return safe;
}

function toggleMobileMenu(force){
  const el=document.getElementById("mobileMenu");
  if(force===false){el.classList.remove("open");return;}
  el.classList.toggle("open");
}
function handleViewport(){
  if(window.innerWidth>=769){toggleMobileMenu(false);}
}
window.addEventListener("resize",handleViewport);
document.addEventListener("DOMContentLoaded",()=>{toggleMobileMenu(false);handleViewport();});

/* ===================== Chat UI ===================== */
function addMessage(from,text){
  const time=new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
  messages.innerHTML+=`<div><span class="time">[${time}]</span> <b>${from}:</b> ${text}</div>`;
  messages.scrollTop=messages.scrollHeight;
}
function addInfo(t){
  messages.innerHTML+=`<div class="info">${t}</div>`;
  messages.scrollTop=messages.scrollHeight;
}
function showTyping(name){
  typingArea.innerHTML=`<div class="typing">${name} yazÄ±yor...</div>`;
  setTimeout(()=>{typingArea.innerHTML="";},1500);
}

/* ===================== Users & Follow ===================== */
function renderUsers(list){
  userList.innerHTML="";userListMobile.innerHTML="";
  list.forEach(u=>{
    const avatar=AVATARS[u.avatar]||AVATARS.default;
    const li=document.createElement("li");
    const star=document.createElement("span");
    star.className="star"+(follows.find(f=>f.uid===u.uid)?" following":"");
    star.textContent="â˜…";
    star.title="Takip et / bÄ±rak";
    star.onclick=(e)=>{e.stopPropagation();toggleFollow(u,star);};
    li.innerHTML=avatar+" "+u.display;
    li.appendChild(star);
    li.onclick=()=>startDM(u);
    userList.appendChild(li);

    // mobil iÃ§in yeni node (listener kaybÄ± olmasÄ±n)
    const mli=document.createElement("li");
    mli.innerHTML=avatar+" "+u.display;
    const mstar=document.createElement("span");
    mstar.className=star.className; mstar.textContent="â˜…"; mstar.title=star.title;
    mstar.onclick=(e)=>{e.stopPropagation();toggleFollow(u,mstar);};
    mli.appendChild(mstar);
    mli.onclick=()=>startDM(u);
    userListMobile.appendChild(mli);
  });
  renderFollows();
}
function renderFollows(){
  followList.innerHTML="";followListMobile.innerHTML="";
  follows.forEach(u=>{
    const avatar=AVATARS[u.avatar]||AVATARS.default;
    const li=document.createElement("li");
    li.innerHTML=avatar+" "+u.display;
    li.onclick=()=>startDM(u);
    followList.appendChild(li);

    const mli=document.createElement("li");
    mli.innerHTML=avatar+" "+u.display;
    mli.onclick=()=>startDM(u);
    followListMobile.appendChild(mli);
  });
}
function toggleFollow(u,starEl){
  const exists=follows.find(f=>f.uid===u.uid);
  if(exists){follows=follows.filter(f=>f.uid!==u.uid);}
  else{follows.push(u);}
  saveFollows();
  if(starEl)starEl.classList.toggle("following");
}

/* ===================== WebSocket ===================== */
function connectWS(){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>sendJoin();
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.type==="info") addInfo(msg.message);
    if(msg.type==="message") addMessage(msg.from,msg.text);
    if(msg.type==="users") renderUsers(msg.users);
    if(msg.type==="typing") showTyping(msg.from);
    if(msg.type==="dm-start") openDM(msg.room,msg.peer);
  };
  ws.onclose=()=>{};
}
function sendJoin(){
  ws.send(JSON.stringify({type:"join",channel:currentChannel,nick:"KullanÄ±cÄ±",token}));
}

/* ===================== Message send ===================== */
form.onsubmit=e=>{
  e.preventDefault();
  let text=input.value.trim();
  if(!text) return;
  text=cleanMessage(text);
  addMessage("Ben",text);

  if(currentChannel==="#heponsigorta"){
    // Sponsor kanal bot cevabÄ±
    fetch(API+"/sponsor",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({text})
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.answer) addMessage("HeponBot ðŸ¤–",data.answer);
    })
    .catch(()=>addMessage("HeponBot ðŸ¤–","ÃœzgÃ¼nÃ¼m, ÅŸu an yanÄ±t veremiyorum."));
  } else {
    ws.send(JSON.stringify({type:"message",text}));
  }
  input.value="";
};
input.addEventListener("input",()=>{
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:"typing"}));
  }
});

/* ===================== Channels ===================== */
function appendChannelItem(ul,name){
  const exists=[...ul.querySelectorAll("li")].some(li=>li.textContent===name);
  if(exists) return;
  const li=document.createElement("li");
  li.textContent=name;
  li.onclick=()=>{
    currentChannel=name;
    topic.textContent=name;
    messages.innerHTML="";
    ws.send(JSON.stringify({type:"join",channel:name,nick:"KullanÄ±cÄ±",token}));
  };
  ul.appendChild(li);
}
function addChannel(name){
  if(!token){alert("Kanal eklemek iÃ§in giriÅŸ yapÄ±n.");return;}
  if(!name.startsWith("#")) name="#"+name;
  currentChannel=name;
  topic.textContent=name;
  messages.innerHTML="";
  appendChannelItem(channelList,name);
  appendChannelItem(channelListMobile,name);
  ws.send(JSON.stringify({type:"join",channel:name,nick:"KullanÄ±cÄ±",token}));
}
btnAddChannel.onclick=()=>{
  const name=newChannel.value.trim();
  if(name) addChannel(name);
  newChannel.value="";
};
btnAddChannelMobile.onclick=()=>{
  const name=newChannelMobile.value.trim();
  if(name) addChannel(name);
  newChannelMobile.value="";
};

/* ===================== DM ===================== */
const dmWindows={};
function startDM(user){
  if(!ws||ws.readyState!==WebSocket.OPEN) return;
  ws.send(JSON.stringify({type:"dm",toUid:user.uid}));
}
function openDM(room,peer){
  if(dmWindows[room]) return;
  const win=document.createElement("div");
  win.className="modal open";
  win.innerHTML=`
    <div class="modal-content" style="width:420px;max-height:90vh;overflow:auto">
      <button class="modal-close" onclick="this.parentElement.parentElement.remove()">âœ–</button>
      <h3>DM: ${peer.display}</h3>
      <div class="messages" id="msg-${room}" style="height:300px"></div>
      <form onsubmit="sendDM('${room}',this);return false;" class="inputbar">
        <input name="text" placeholder="Mesaj yaz..." maxlength="1000"/><button>GÃ¶nder</button>
      </form>
      <div class="muted">DM kayÄ±tlarÄ± tarayÄ±cÄ±nda saklanÄ±r ve silinmez.</div>
    </div>`;
  document.body.appendChild(win);
  dmWindows[room]=win;

  const box=document.getElementById("msg-"+room);
  const history=JSON.parse(localStorage.getItem("dmHistory_"+room)||"[]");
  history.forEach(m=>{
    box.innerHTML+=`<div><span class="time">[${m.time}]</span> <b>${m.from}:</b> ${m.text}</div>`;
  });
  box.scrollTop=box.scrollHeight;
}
function sendDM(room,formEl){
  const raw=(formEl.text.value||"").trim();
  const text=cleanMessage(raw);
  if(!text) return;
  const time=new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
  const box=document.getElementById("msg-"+room);
  const entry={time,from:"Ben",text};
  box.innerHTML+=`<div><span class="time">[${time}]</span> <b>Ben:</b> ${text}</div>`;
  box.scrollTop=box.scrollHeight;
  ws.send(JSON.stringify({type:"message",text,channel:room}));
  const history=JSON.parse(localStorage.getItem("dmHistory_"+room)||"[]");
  history.push(entry);
  localStorage.setItem("dmHistory_"+room,JSON.stringify(history));
  formEl.text.value="";
}

/* ===================== Auth ===================== */
btnLogin.onclick=()=>loginModal.classList.add("open");

doLogin.onclick=async()=>{
  try{
    const identifier=document.getElementById("identifier").value.trim();
    const password=document.getElementById("password").value;
    const res=await fetch(API+"/login",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({identifier,password})
    });
    const data=await res.json();
    if(!res.ok||!data.success) throw new Error(data?.error||("HTTP "+res.status));

    token=data.token;
    localStorage.setItem("token",token);
    authStatus.textContent=identifier;

    btnLogin.style.display="none";
    btnProfile.style.display="inline-block";
    btnLogout.style.display="inline-block";
    loginModal.classList.remove("open");

    document.getElementById("addChannelBox").style.display="block";
    document.getElementById("addChannelBoxMobile").style.display="block";

    try{ws&&ws.close();}catch{}
    connectWS();
  }catch(err){
    alert("GiriÅŸ hatasÄ±: "+err.message);
  }
};

doRegister.onclick=async()=>{
  try{
    const identifier=document.getElementById("identifier").value.trim();
    const password=document.getElementById("password").value;
    const res=await fetch(API+"/register",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({identifier,password})
    });
    const data=await res.json();
    if(!res.ok||!data.success) throw new Error(data?.error||("HTTP "+res.status));
    alert("KayÄ±t baÅŸarÄ±lÄ±. Åžimdi giriÅŸ yapabilirsiniz.");
  }catch(err){
    alert("KayÄ±t hatasÄ±: "+err.message);
  }
};

btnLogout.onclick=()=>{
  localStorage.removeItem("token");
  token=null;
  location.reload();
};

btnProfile.onclick=()=>{
  if(!token){
    alert("Profil dÃ¼zenlemek iÃ§in giriÅŸ yapÄ±n.");
    loginModal.classList.add("open");
  }else{
    profileModal.classList.add("open");
  }
};

saveProfile.onclick=async()=>{
  const genderVal=(gender.value||"").toLowerCase();
  let avatar="default";
  if(genderVal==="erkek") avatar="male";
  else if(genderVal==="kadÄ±n") avatar="female";

  const profile={
    firstName:firstName.value,
    lastName:lastName.value,
    gender:gender.value,
    birth:birth.value,
    country:country.value,
    city:city.value,
    avatar
  };
  const res=await fetch(API+"/profile/update",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({token,profile})
  });
  const data=await res.json();
  if(data.success){
    alert("Profil gÃ¼ncellendi");
    profileModal.classList.remove("open");
  }else{
    alert("Profil gÃ¼ncellenemedi");
  }
};

/* ===================== Sponsor Kanal ===================== */
function joinSponsor(){
  currentChannel="#heponsigorta";
  topic.textContent="#heponsigorta";
  messages.innerHTML="";
  addInfo("Hepon Sigortaâ€™ya hoÅŸ geldiniz. Daha fazla bilgi: www.heponsigorta.com");
}

/* ===================== Channels init ===================== */
function initChannelsUI(){
  const defaults=["#genel","#sohbet","#yardim"];
  const render=(ul)=>{
    ul.innerHTML="";
    defaults.forEach(name=>{
      const li=document.createElement("li");
      li.textContent=name;
      li.onclick=()=>{
        currentChannel=name;
        topic.textContent=name;
        messages.innerHTML="";
        ws.send(JSON.stringify({type:"join",channel:name,nick:"KullanÄ±cÄ±",token}));
      };
      ul.appendChild(li);
    });
  };
  render(channelList);
  render(channelListMobile);

  document.getElementById("addChannelBox").style.display = token ? "block" : "none";
  document.getElementById("addChannelBoxMobile").style.display = token ? "block" : "none";
}

/* =============== YENÄ°: Emoji Picker davranÄ±ÅŸÄ± =============== */
const btnEmoji = document.getElementById("btnEmoji");
const emojiBox = document.getElementById("emojiBox");
if(btnEmoji && emojiBox){
  btnEmoji.onclick = ()=>{
    emojiBox.style.display = (emojiBox.style.display==="none" ? "block" : "none");
    const rect = btnEmoji.getBoundingClientRect();
    emojiBox.style.left = (rect.left)+"px";
    emojiBox.style.top  = (rect.bottom+6)+"px";
  };
  emojiBox.addEventListener("emoji-click", e=>{
    input.value += e.detail.unicode;
    input.focus();
    emojiBox.style.display="none";
  });
}

/* =============== YENÄ°: Hobiler / Ä°lgi AlanlarÄ± =============== */
const ALL_HOBBIES = [
  "Futbol","Basketbol","Voleybol","KoÅŸu","Fitness","YÃ¼zme","Tenis","MMA","DalÄ±ÅŸ","Kamp",
  "Bilgisayar OyunlarÄ±","Mobil Oyunlar","CS:GO","LoL","Valorant","SatranÃ§",
  "Film","Dizi","Netflix","Anime","Belgesel",
  "MÃ¼zik","Rock","Rap","Klasik","Piyano","Gitar","DJ",
  "Kitap","Roman","Åžiir","KiÅŸisel GeliÅŸim","Felsefe",
  "Yemek","TatlÄ±","Kahve","Ã‡ay","BarbekÃ¼","Vegan",
  "Teknoloji","YazÄ±lÄ±m","Yapay ZekÃ¢","Siber GÃ¼venlik","Kripto",
  "Seyahat","FotoÄŸraf","DoÄŸa","Resim","Heykel","TasarÄ±m","Moda",
  "Araba","Motosiklet","Drone","RC","Model",
  "Dil Ã–ÄŸrenme","Ä°ngilizce","Almanca","Ä°spanyolca","TÃ¼rkÃ§e",
  "GiriÅŸimcilik","Pazarlama","E-ticaret","YatÄ±rÄ±m","Borsa",
  "SaÄŸlÄ±k","Psikoloji","Meditasyon","Yoga","Mindfulness"
];
const HOBBY_TO_CHANNELS = {
  "Futbol":["#futbol","#spor"], "Basketbol":["#basketbol","#spor"],
  "YazÄ±lÄ±m":["#yazÄ±lÄ±m","#teknoloji"], "Yapay ZekÃ¢":["#yapayzeka","#teknoloji"],
  "Yemek":["#yemek","#tarifler"], "Film":["#film","#sohbet"], "MÃ¼zik":["#mÃ¼zik","#sohbet"]
};
const hobbyPicked = new Set(JSON.parse(localStorage.getItem("hobbies")||"[]"));

const btnHobbies = document.getElementById("btnHobbies");
if(btnHobbies){
  btnHobbies.onclick = openHobbyModal;
}

function openHobbyModal(){
  hobbyModal.classList.add("open");
  const list = document.getElementById("hobbyList");
  list.innerHTML="";
  ALL_HOBBIES.forEach(h=>{
    const row=document.createElement("div");
    row.style.display="flex"; row.style.justifyContent="space-between"; row.style.padding="4px 0";
    const span=document.createElement("span"); span.textContent=h;
    const add=document.createElement("button"); add.textContent="+";
    add.onclick=()=>{ hobbyPicked.add(h); renderPicked(); };
    row.append(span,add); list.appendChild(row);
  });
  renderPicked();
}
function renderPicked(){
  document.getElementById("hobbyPicked").textContent = [...hobbyPicked].join(", ");
}
document.getElementById("saveHobbies").onclick = async ()=>{
  const arr = [...hobbyPicked];
  localStorage.setItem("hobbies", JSON.stringify(arr));
  // profiline de yaz (giriÅŸ varsa)
  if(token){
    try{
      const r=await fetch(API+"/me",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token})});
      const d=await r.json(); const prof = d.profile||{};
      prof.hobbies = arr;
      await fetch(API+"/profile/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token,profile:prof})});
    }catch(e){}
  }
  // Ã¶nerilen kanallarÄ± ekle
  arr.forEach(h=> (HOBBY_TO_CHANNELS[h]||[]).forEach(ch=> addChannel(ch)));
  hobbyModal.classList.remove("open");
};

/* =============== YENÄ°: Ã–neri / Feedback =============== */
const btnFeedback = document.getElementById("btnFeedback");
if(btnFeedback){
  btnFeedback.onclick = ()=> feedbackModal.classList.add("open");
}
const sendFeedbackBtn = document.getElementById("sendFeedback");
if(sendFeedbackBtn){
  sendFeedbackBtn.onclick = async ()=>{
    const text = (document.getElementById("feedbackText").value||"").trim();
    if(!text) return;
    try{
      const r = await fetch(API+"/feedback",{ method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ token, text })});
      const d = await r.json();
      if(d.success){ alert("TeÅŸekkÃ¼rler! Ã–neriniz alÄ±ndÄ±."); feedbackModal.classList.remove("open"); }
      else { alert(d.error || "GÃ¶nderilemedi"); }
    }catch(e){
      alert("GÃ¶nderilemedi");
    }
  };
}

/* ===================== Boot ===================== */
function initAfterAuthUI(){
  document.getElementById("addChannelBox").style.display="block";
  document.getElementById("addChannelBoxMobile").style.display="block";
}
if(token){
  authStatus.textContent="GiriÅŸ yapÄ±ldÄ±";
  btnLogin.style.display="none";
  btnProfile.style.display="inline-block";
  btnLogout.style.display="inline-block";
  initChannelsUI();
  initAfterAuthUI();
  connectWS();
}else{
  initChannelsUI();
  connectWS();
}
</script>
</body>
</html>
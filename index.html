<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anonim Sohbet (mIRC Tarzƒ±)</title>
  <style>
    body{margin:0;font-family:"Courier New",monospace;background:#000;color:#eee}
    .menubar{display:flex;justify-content:space-between;background:#111;padding:6px;border-bottom:1px solid #333}
    .menubar button{background:#222;border:1px solid #444;color:#eee;padding:4px 10px;cursor:pointer}
    .layout{display:grid;grid-template-columns:240px 1fr 200px;height:calc(100vh - 38px)}
    .pane{background:#111;border-right:1px solid #333;display:flex;flex-direction:column}
    .pane-right{border-left:1px solid #333}
    .pane-title{padding:6px;font-weight:bold;border-bottom:1px solid #333}
    .list{list-style:none;margin:0;padding:6px;overflow:auto}
    .list li{padding:4px 6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .list li.active{background:#1b1b1b}
    .deleteBtn{background:none;border:none;color:#f55;cursor:pointer;font-size:12px}
    .center{display:flex;flex-direction:column}
    .topic{padding:6px;text-align:center;border-bottom:1px solid #333;color:#aaa}
    .messages{flex:1;overflow:auto;padding:6px;font-size:13px;background:#000}
    .message{margin:2px 0}
    .message .nick{font-weight:bold;margin-right:4px}
    .time{color:#888;font-size:11px;margin-right:6px}
    .info{color:#888;text-align:center;font-style:italic;margin:4px 0}
    .inputbar{display:flex;border-top:1px solid #333;background:#111}
    .inputbar input{flex:1;background:#000;color:#eee;border:1px solid #333;padding:6px}
    .inputbar button{background:#222;color:#eee;border:1px solid #333;padding:6px}
  </style>
</head>
<body>
  <div class="menubar">
    <div>
      <button id="btnProfile">Profil</button>
      <button id="btnAddChannel">Kanal Ekle</button>
      <button id="btnClear">√áƒ±kƒ±≈ü</button>
    </div>
    <div>/irc-web</div>
  </div>

  <div class="layout">
    <aside class="pane">
      <div class="pane-title">üîù Pop√ºler Kanallar</div>
      <ul id="popularList" class="list"></ul>
      <div class="pane-title">üë§ Benim Kanallarƒ±m</div>
      <ul id="myList" class="list"></ul>
    </aside>
    <main class="center">
      <div id="topic" class="topic">#genel ‚Äî 0 ki≈üi</div>
      <div id="messages" class="messages"></div>
      <form id="form" class="inputbar"><input id="input" placeholder="Mesaj yaz..."/><button>G√∂nder</button></form>
    </main>
    <aside class="pane pane-right">
      <div class="pane-title">Kullanƒ±cƒ±lar</div>
      <ul id="userList" class="list"></ul>
    </aside>
  </div>

  <!-- Kanal Ekle Modal -->
  <div id="addChannelModal" class="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center">
    <div class="modal-content" style="background:#111;padding:14px;border:1px solid #333;display:grid;gap:6px;min-width:280px">
      <h3>Yeni Kanal</h3>
      <input id="newChannelInput" placeholder="#kanal-adi"/>
      <div class="modal-actions" style="display:flex;gap:8px">
        <button id="confirmAddChannel">Ekle</button>
        <button id="cancelAddChannel">ƒ∞ptal</button>
      </div>
    </div>
  </div>

<script>
const WS_URL="wss://chat-backend-1-iq7t.onrender.com";
let currentChannel="#genel";let messagesByChannel={};let usersInRoom=[];
let anonName=localStorage.getItem("anonName")||("User"+Math.floor(Math.random()*1000));localStorage.setItem("anonName",anonName);

// Varsayƒ±lan pop√ºler kanallar
let popularChannels=["#genel","#teknoloji","#oyun","#spor","#m√ºzik"];
// Kullanƒ±cƒ±ya ait kanallar localStorage'dan y√ºklenir
let myChannels=JSON.parse(localStorage.getItem("myChannels")||"[]");

// Renkler
const nickColors=["#4fc3f7","#a5d6a7","#ffcc80","#f48fb1","#ce93d8","#80cbc4","#e6ee9c"];
let colorMap={};function getNickColor(nick){if(!colorMap[nick]){colorMap[nick]=nickColors[Object.keys(colorMap).length%nickColors.length];}return colorMap[nick];}

// HTML
const popularListEl=document.getElementById("popularList"),myListEl=document.getElementById("myList"),userListEl=document.getElementById("userList"),messagesEl=document.getElementById("messages"),topicEl=document.getElementById("topic"),form=document.getElementById("form"),input=document.getElementById("input");

// Render Fonksiyonlarƒ±
function renderLists(){
  // pop√ºler
  popularListEl.innerHTML="";popularChannels.forEach(ch=>{
    let li=document.createElement("li");li.textContent=ch;if(ch===currentChannel)li.classList.add("active");li.onclick=()=>switchChannel(ch);popularListEl.appendChild(li);
  });
  // benim kanallarƒ±m
  myListEl.innerHTML="";myChannels.forEach(ch=>{
    let li=document.createElement("li");let span=document.createElement("span");span.textContent=ch;li.appendChild(span);
    if(ch===currentChannel)li.classList.add("active");span.onclick=()=>switchChannel(ch);
    let del=document.createElement("button");del.textContent="‚ùå";del.className="deleteBtn";del.onclick=(e)=>{e.stopPropagation();removeMyChannel(ch);};li.appendChild(del);
    myListEl.appendChild(li);
  });
}
function renderUsers(list){usersInRoom=list||[];userListEl.innerHTML="";(list||[]).forEach(n=>{let li=document.createElement("li");li.textContent=n;li.style.color=getNickColor(n);userListEl.appendChild(li);});let ai=document.createElement("li");ai.textContent="AI";ai.style.color="#ffcc00";userListEl.appendChild(ai);updateTopic();}
function updateTopic(){topicEl.textContent=`${currentChannel} ‚Äî ${usersInRoom.length} ki≈üi`;}

// Mesaj
function formatTime(){return new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});}
function addMessage(from,text,cls){if(!messagesByChannel[currentChannel])messagesByChannel[currentChannel]=[];messagesByChannel[currentChannel].push({from,text,cls});let row=document.createElement("div");row.className="message "+cls;let time=document.createElement("span");time.className="time";time.textContent=`[${formatTime()}]`;let nick=document.createElement("span");nick.className="nick";nick.style.color=getNickColor(from);nick.textContent=from+":";row.appendChild(time);row.appendChild(nick);row.appendChild(document.createTextNode(" "+text));messagesEl.appendChild(row);messagesEl.scrollTop=messagesEl.scrollHeight;}
function addInfo(text){let div=document.createElement("div");div.className="info";div.textContent=text;messagesEl.appendChild(div);messagesEl.scrollTop=messagesEl.scrollHeight;}

// WS
let ws;function connectWS(){ws=new WebSocket(WS_URL);ws.onopen=()=>{ws.send(JSON.stringify({type:"join",channel:currentChannel,nick:anonName}));};ws.onmessage=ev=>{let msg=JSON.parse(ev.data);if(msg.type==="info")addInfo(msg.message);else if(msg.type==="users")renderUsers(msg.users);else if(msg.type==="message")addMessage(msg.from,msg.text,"other");};}
function switchChannel(ch){currentChannel=ch;messagesEl.innerHTML="";addInfo(ch+" kanalƒ±na girdin.");if(ws&&ws.readyState===1){ws.send(JSON.stringify({type:"join",channel:ch,nick:anonName}));}}

// Kanal Ekle/Sil
function addMyChannel(ch){if(!ch.startsWith("#"))ch="#"+ch;if(!myChannels.includes(ch)){myChannels.push(ch);localStorage.setItem("myChannels",JSON.stringify(myChannels));renderLists();}}
function removeMyChannel(ch){myChannels=myChannels.filter(c=>c!==ch);localStorage.setItem("myChannels",JSON.stringify(myChannels));renderLists();}

// Eventler
form.onsubmit=e=>{e.preventDefault();let text=input.value.trim();if(!text)return;addMessage(anonName,text,"me");input.value="";if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:"message",text}));};
document.getElementById("btnClear").onclick=()=>{localStorage.clear();location.reload();}
document.getElementById("btnAddChannel").onclick=()=>document.getElementById("addChannelModal").style.display="flex";
document.getElementById("confirmAddChannel").onclick=()=>{let ch=document.getElementById("newChannelInput").value.trim();if(ch)addMyChannel(ch);document.getElementById("newChannelInput").value="";document.getElementById("addChannelModal").style.display="none";}
document.getElementById("cancelAddChannel").onclick=()=>document.getElementById("addChannelModal").style.display="none";

// Ba≈ülat
renderLists();switchChannel(currentChannel);connectWS();
</script>
</body>
</html>

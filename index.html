<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anonim Sohbet (mIRC Tarzı)</title>
  <style>
    body{margin:0;font-family:"Courier New",monospace;background:#000;color:#eee}
    .menubar{display:flex;justify-content:space-between;background:#111;padding:6px;border-bottom:1px solid #333}
    .menubar button{background:#222;border:1px solid #444;color:#eee;padding:4px 10px;cursor:pointer}
    .layout{display:grid;grid-template-columns:200px 1fr 200px;height:calc(100vh - 38px)}
    .pane{background:#111;border-right:1px solid #333;display:flex;flex-direction:column}
    .pane-right{border-left:1px solid #333}
    .pane-title{padding:6px;font-weight:bold;border-bottom:1px solid #333}
    .list{list-style:none;margin:0;padding:6px;overflow:auto}
    .center{display:flex;flex-direction:column}
    .topic{padding:6px;text-align:center;border-bottom:1px solid #333;color:#aaa}
    .messages{flex:1;overflow:auto;padding:6px;font-size:13px;background:#000}
    .message{margin:2px 0}
    .message .nick{font-weight:bold;margin-right:4px}
    .message.me{color:#4fc3f7}.message.other{color:#a5d6a7}.info{color:#888;text-align:center;font-style:italic}
    .inputbar{display:flex;border-top:1px solid #333;background:#111}
    .inputbar input{flex:1;background:#000;color:#eee;border:1px solid #333;padding:6px}
    .inputbar button{background:#222;color:#eee;border:1px solid #333;padding:6px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .modal-content{background:#111;padding:14px;border:1px solid #333;display:grid;gap:6px;min-width:280px}
    .modal-content input{background:#000;color:#eee;border:1px solid #333;padding:6px}
    .modal-actions{display:flex;gap:8px;margin-top:6px}
  </style>
</head>
<body>
  <div class="menubar">
    <div><button id="btnProfile">Profil</button><button id="btnClear">Çıkış</button></div>
    <div>/irc-web</div>
  </div>
  <div class="layout">
    <aside class="pane"><div class="pane-title">Kanallar</div><ul id="channelList" class="list"></ul></aside>
    <main class="center">
      <div id="topic" class="topic">#genel — Anonim</div>
      <div id="messages" class="messages"></div>
      <form id="form" class="inputbar"><input id="input"/><button>Gönder</button></form>
    </main>
    <aside class="pane pane-right"><div class="pane-title">Kullanıcılar</div><ul id="userList" class="list"></ul></aside>
  </div>

  <div id="profileModal" class="modal">
    <div class="modal-content">
      <h3>Profil (Opsiyonel)</h3>
      <label>İsim</label><input id="firstName"/>
      <label>Soyisim</label><input id="lastName"/>
      <label>Email</label><input id="email"/>
      <label>Ülke</label><input id="countrySelect"/>
      <label>Şehir</label><input id="citySelect"/>
      <div class="modal-actions"><button id="saveProfile">Kaydet</button><button id="skipProfile">Anonim</button></div>
    </div>
  </div>

<script>
const WS_URL="wss://chat-backend-1-iq7t.onrender.com";
let currentChannel="#genel";let messagesByChannel={};let anonName=localStorage.getItem("anonName")||("User"+Math.floor(Math.random()*1000));localStorage.setItem("anonName",anonName);

const channelListEl=document.getElementById("channelList"),userListEl=document.getElementById("userList"),messagesEl=document.getElementById("messages"),form=document.getElementById("form"),input=document.getElementById("input"),profileModal=document.getElementById("profileModal");

function renderChannels(){channelListEl.innerHTML="";["#genel","#teknoloji","#oyun"].forEach(ch=>{let li=document.createElement("li");li.textContent=ch;if(ch===currentChannel)li.classList.add("active");li.onclick=()=>switchChannel(ch);channelListEl.appendChild(li);});}
function renderUsers(list){userListEl.innerHTML="";let me=document.createElement("li");me.textContent=anonName;me.style.color="#4fc3f7";userListEl.appendChild(me);(list||[]).forEach(n=>{if(n!==anonName){let li=document.createElement("li");li.textContent=n;li.style.color="#a5d6a7";userListEl.appendChild(li);}});let ai=document.createElement("li");ai.textContent="AI";ai.style.color="#ffcc00";userListEl.appendChild(ai);}
function addMessage(from,text,cls){if(!messagesByChannel[currentChannel])messagesByChannel[currentChannel]=[];messagesByChannel[currentChannel].push({from,text,cls});let row=document.createElement("div");row.className="message "+cls;let nick=document.createElement("span");nick.className="nick";nick.textContent=from+":";row.appendChild(nick);row.appendChild(document.createTextNode(" "+text));messagesEl.appendChild(row);messagesEl.scrollTop=messagesEl.scrollHeight;}
function addInfo(text){let div=document.createElement("div");div.className="info";div.textContent=text;messagesEl.appendChild(div);messagesEl.scrollTop=messagesEl.scrollHeight;}

let ws;function connectWS(){ws=new WebSocket(WS_URL);ws.onopen=()=>{ws.send(JSON.stringify({type:"join",channel:currentChannel,nick:anonName}));};ws.onmessage=ev=>{let msg=JSON.parse(ev.data);if(msg.type==="info")addInfo(msg.message);else if(msg.type==="users")renderUsers(msg.users);else if(msg.type==="message")addMessage(msg.from,msg.text,"other");};}
function switchChannel(ch){currentChannel=ch;messagesEl.innerHTML="";addInfo(ch+" kanalına girdin.");if(ws&&ws.readyState===1){ws.send(JSON.stringify({type:"join",channel:ch,nick:anonName}));}}
form.onsubmit=e=>{e.preventDefault();let text=input.value.trim();if(!text)return;addMessage(anonName,text,"me");input.value="";if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:"message",text}));};

document.getElementById("btnProfile").onclick=()=>profileModal.classList.add("open");
document.getElementById("btnClear").onclick=()=>{localStorage.clear();location.reload();}
document.getElementById("saveProfile").onclick=()=>{let p={first:document.getElementById("firstName").value,last:document.getElementById("lastName").value,email:document.getElementById("email").value,country:document.getElementById("countrySelect").value,city:document.getElementById("citySelect").value};localStorage.setItem("profile",JSON.stringify(p));profileModal.classList.remove("open");}
document.getElementById("skipProfile").onclick=()=>profileModal.classList.remove("open");

async function detectLocation(){try{const res=await fetch("https://ipapi.co/json/");const data=await res.json();if(data.country_name)document.getElementById("countrySelect").value=data.country_name;if(data.city)document.getElementById("citySelect").value=data.city;}catch(e){console.error("Konum alınamadı",e);}}
renderChannels();switchChannel(currentChannel);connectWS();profileModal.classList.add("open");detectLocation();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Anonim Sohbet</title>
  <style>
    body{margin:0;font-family:"Courier New",monospace;background:#000;color:#eee}
    .menubar{display:flex;justify-content:space-between;align-items:center;background:#111;padding:6px;border-bottom:1px solid #333}
    .menubar button{background:#222;border:1px solid #444;color:#eee;padding:4px 10px;cursor:pointer;margin-right:4px}
    .layout{display:grid;grid-template-columns:240px 1fr 220px;height:calc(100vh - 38px)}
    .pane{background:#111;border-right:1px solid #333;display:flex;flex-direction:column}
    .pane-right{border-left:1px solid #333}
    .pane-title{padding:6px;font-weight:bold;border-bottom:1px solid #333}
    .list{list-style:none;margin:0;padding:6px;overflow:auto}
    .list li{padding:4px 6px;display:flex;gap:6px;align-items:center;justify-content:space-between}
    .list li span.item{flex:1;cursor:pointer}
    .list li.active{background:#1b1b1b}
    .dmBtn{background:none;border:1px solid #444;color:#eee;cursor:pointer;font-size:12px;padding:2px 6px}
    .center{display:flex;flex-direction:column}
    .topic{padding:6px;text-align:center;border-bottom:1px solid #333;color:#aaa}
    .messages{flex:1;overflow:auto;padding:6px;font-size:13px;background:#000}
    .message{margin:2px 0}
    .message .nick{font-weight:bold;margin-right:4px}
    .time{color:#888;font-size:11px;margin-right:6px}
    .info{color:#888;text-align:center;font-style:italic;margin:4px 0}
    .inputbar{display:flex;border-top:1px solid #333;background:#111}
    .inputbar input{flex:1;background:#000;color:#eee;border:1px solid #333;padding:6px}
    .inputbar button{background:#222;color:#eee;border:1px solid #333;padding:6px}
    @media(max-width:768px){.layout{grid-template-columns:1fr}.pane,.pane-right{display:none}.menubar .mobile-toggle{display:inline-block}}
    @media(min-width:769px){.menubar .mobile-toggle{display:none}}
    #mobileMenu{position:fixed;top:0;left:-260px;width:260px;height:100%;background:#111;border-right:1px solid #333;transition:left .3s;z-index:1000;padding:6px}
    #mobileMenu.open{left:0}
    #mobileMenu .closeBtn{background:#222;border:1px solid #444;color:#eee;width:100%;margin-bottom:8px;padding:6px;cursor:pointer}
  </style>
</head>
<body>
  <div class="menubar">
    <button class="mobile-toggle" onclick="toggleMobileMenu()">‚ò∞ Men√º</button>
  </div>
  <div id="mobileMenu">
    <button class="closeBtn" onclick="toggleMobileMenu()">‚úñ Kapat</button>
    <div class="pane-title">‚≠ê Takip Ettiklerim</div><ul id="followedListMobile" class="list"></ul>
    <div class="pane-title">üîù Pop√ºler Kanallar</div><ul id="popularListMobile" class="list"></ul>
    <div class="pane-title">üë§ Kanallarƒ±m</div><ul id="myListMobile" class="list"></ul>
    <div class="pane-title">Kullanƒ±cƒ±lar</div><ul id="userListMobile" class="list"></ul>
  </div>
  <div class="layout">
    <aside class="pane">
      <div class="pane-title">‚≠ê Takip Ettiklerim</div><ul id="followedList" class="list"></ul>
      <div class="pane-title">üîù Pop√ºler Kanallar</div><ul id="popularList" class="list"></ul>
      <div class="pane-title">üë§ Kanallarƒ±m</div><ul id="myList" class="list"></ul>
    </aside>
    <main class="center">
      <div id="topic" class="topic">#genel</div>
      <div id="messages" class="messages"></div>
      <form id="form" class="inputbar"><input id="input" placeholder="Mesaj yaz..."/><button>G√∂nder</button></form>
    </main>
    <aside class="pane pane-right"><div class="pane-title">Kullanƒ±cƒ±lar</div><ul id="userList" class="list"></ul></aside>
  </div>

<script>
const WS_URL="wss://chat-backend-1-iq7t.onrender.com";
let currentChannel="#genel",ws,usersInRoom=[];
let anonName=localStorage.getItem("anonName")||("User"+Math.floor(Math.random()*1000));
localStorage.setItem("anonName",anonName);
let profile=JSON.parse(localStorage.getItem("profile")||"{}");
let followed=JSON.parse(localStorage.getItem("followedUsers")||"[]");

function toggleMobileMenu(force){const el=document.getElementById("mobileMenu");if(force===false){el.classList.remove("open");return;}el.classList.toggle("open");}
function formatTime(){return new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});}
function addMessage(from,text,cls){const row=document.createElement("div");row.className="message "+cls;row.innerHTML=`<span class="time">[${formatTime()}]</span><span class="nick">${from}:</span> ${text}`;messages.appendChild(row);messages.scrollTop=messages.scrollHeight;}
function addInfo(text){const div=document.createElement("div");div.className="info";div.textContent=text;messages.appendChild(div);messages.scrollTop=messages.scrollHeight;}
function updateTopic(){topic.textContent=currentChannel;}

function renderUsers(list){
  userList.innerHTML=""; userListMobile.innerHTML="";
  (list||[]).forEach(u=>{
    const li=document.createElement("li");
    const span=document.createElement("span"); span.className="item"; span.textContent=u.display||u.nick;
    const star=document.createElement("button");star.textContent=followed.includes(u.uid)?"‚òÖ":"‚òÜ";star.className="dmBtn";
    star.onclick=(e)=>{e.stopPropagation();toggleFollow(u.uid);renderFollowed();renderUsers(list);};
    const dm=document.createElement("button");dm.textContent="DM";dm.className="dmBtn";dm.onclick=(e)=>{e.stopPropagation();startDM(u.uid,u.display);};
    li.appendChild(span);li.appendChild(star);li.appendChild(dm);
    userList.appendChild(li); userListMobile.appendChild(li.cloneNode(true));
  });
  updateTopic();
}

function toggleFollow(uid){if(followed.includes(uid))followed=followed.filter(x=>x!==uid);else followed.push(uid);localStorage.setItem("followedUsers",JSON.stringify(followed));}
function renderFollowed(){followedList.innerHTML="";followedListMobile.innerHTML="";followed.forEach(uid=>{const li=document.createElement("li");li.textContent=uid;li.onclick=()=>startDM(uid,uid);followedList.appendChild(li);followedListMobile.appendChild(li.cloneNode(true));});}

function startDM(toUid,label){ws.send(JSON.stringify({type:"dm",toUid}));topic.textContent=`DM: ${label}`;}
function handleDMHistory(msg){messages.innerHTML="";(msg.history||[]).forEach(m=>addMessage(m.from,m.text,"other"));}

function connectWS(){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>sendJoin();
  ws.onmessage=ev=>{
    const msg=JSON.parse(ev.data);
    if(msg.type==="info")addInfo(msg.message);
    if(msg.type==="users")renderUsers(msg.users);
    if(msg.type==="message")addMessage(msg.from,msg.text,"other");
    if(msg.type==="channels"){} // pop√ºler listesi eklenebilir
    if(msg.type==="dm-start"){currentChannel=msg.room;topic.textContent=`DM: ${msg.peer.display}`;sendJoin();}
    if(msg.type==="dm-history")handleDMHistory(msg);
  };
}
function sendJoin(){ws.send(JSON.stringify({type:"join",channel:currentChannel,nick:anonName,profile:{country:profile.country,city:profile.city}}));}

form.onsubmit=e=>{e.preventDefault();const text=input.value.trim();if(!text)return;addMessage(anonName,text,"me");input.value="";ws.send(JSON.stringify({type:"message",text}));};

renderFollowed();updateTopic();connectWS();
</script>
</body>
</html>
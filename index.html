<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Anonim Sohbet</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Emoji Picker lib -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
</head>
<body>
  <div class="menubar">
    <button class="mobile-toggle" onclick="toggleMobileMenu()">☰ <span data-translate="menu">Menü</span></button>
    <span id="authStatus" data-translate="anonymous">Anonim</span>
    <div>
      <button id="btnLocation" data-translate="location">🌍 Lokasyon</button>
      <button id="btnFeedback" data-translate="feedback">Öneri</button>
      <button id="btnDonate" data-translate="donate">☕ Kahve İkram Et</button>
      <button id="btnLogin" data-translate="login">Giriş</button>
      <button id="btnProfile" style="display:none" data-translate="profile">Profil Düzenle</button>
      <button id="btnLogout" style="display:none" data-translate="logout">Çıkış</button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div id="mobileMenu">
    <button class="closeBtn" onclick="toggleMobileMenu(false)">✖ Kapat</button>
    
    <div class="pane-title" data-translate="sponsorChannelsTitle">💰 Sponsor Kanallar</div>
    <ul id="sponsorListMobile" class="list"></ul>

    <div class="pane-title" data-translate="generalChannelsTitle">🌐 Genel Kanallar</div>
    <ul id="channelListMobile" class="list"></ul>

    <div class="pane-title" data-translate="favoriteCitiesTitle">🏙️ Favori Şehirler</div>
    <ul id="favListMobile" class="list"></ul>

    <div class="pane-title" data-translate="users">Kullanıcılar</div>
    <ul id="userListMobile" class="list"></ul>

    <div class="pane-title" data-translate="following">Takip Ettiklerim</div>
    <ul id="followListMobile" class="list"></ul>

    <div style="padding:10px;border-top:1px solid #333;text-align:center;">
      <button id="btnDonateMobile" data-translate="donate" style="background:#FFDD00;color:#000;border:none;padding:8px 16px;border-radius:20px;font-weight:bold;cursor:pointer;">☕ Kahve İkram Et</button>
    </div>

    <div id="addChannelBoxMobile" style="display:none;padding:6px;border-top:1px solid #333">
      <input id="newChannelMobile" placeholder="#kanal-adı" style="width:100%;margin-bottom:4px"/>
      <button id="btnAddChannelMobile" style="width:100%">Ekle</button>
      <div class="hint muted">Kendi kanalını ekle (#konya gibi).</div>
    </div>
  </div>

  <div class="layout">
    <aside class="pane">
      <div class="pane-title" data-translate="sponsorChannelsTitle">💰 Sponsor Kanallar</div>
      <ul id="sponsorList" class="list"></ul>

      <div class="pane-title" data-translate="generalChannelsTitle">🌐 Genel Kanallar</div>
      <ul id="channelList" class="list"></ul>

      <div class="pane-title" data-translate="favoriteCitiesTitle">🏙️ Favori Şehirler</div>
      <ul id="favList" class="list"></ul>

      <div class="pane-title" data-translate="myChannelsTitle">🎯 Kendi Kanallarım</div>
      <ul id="myChannelsList" class="list"></ul>

      <div id="addChannelBox" style="display:none;padding:6px;border-top:1px solid #333">
        <button id="btnCreateChannel" style="width:100%" data-translate="createChannelBtn">🎯 Kanal Oluştur</button>
        <div class="hint muted" data-translate="channelHint">Kendi kanalını oluştur ve yönet.</div>
      </div>
    </aside>

    <main class="center">
      <div id="topic" class="topic">#genel</div>
      <div id="messages" class="messages"></div>
      <div id="typingArea"></div>
      <form id="form" class="inputbar" autocomplete="off">
        <input id="input" placeholder="Mesaj yaz..." maxlength="1000"/>
        <button>Gönder</button>
        <button type="button" id="btnEmoji" title="Emoji">😀</button>
      </form>
      <emoji-picker id="emojiBox"></emoji-picker>
    </main>

    <aside class="pane pane-right">
      <div class="pane-title" data-translate="users">Kullanıcılar</div>
      <ul id="userList" class="list"></ul>
      <div class="pane-title" data-translate="following">Takip Ettiklerim</div>
      <ul id="followList" class="list"></ul>
    </aside>
  </div>

  <!-- 🔐 Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="loginModal.classList.remove('open')">✖</button>
      <h3 data-translate="loginTitle">Giriş / Kayıt</h3>
      <input id="identifier" placeholder="Email veya Telefon" data-placeholder="email"/>
      <input id="password" type="password" placeholder="Şifre" data-placeholder="password"/>
      
      <!-- Beni Hatırla checkbox -->
      <div style="display: flex; align-items: center; margin: 10px 0;">
        <input type="checkbox" id="rememberMe" style="margin-right: 8px;">
        <label for="rememberMe" data-translate="rememberMe">Beni Hatırla</label>
      </div>
      
      <div class="section">
        <button id="doLogin" data-translate="loginBtn">Giriş</button>
        <button id="doRegister" data-translate="registerBtn">Kayıt</button>
      </div>
      <div class="muted" data-translate="loginHint">Giriş yapmadan anonim sohbet edebilirsin; fakat DM, arkadaş ekleme ve kanal ekleme için giriş gerekir.</div>
    </div>
  </div>

  <!-- 🌍 Lokasyon Modal -->
  <div id="locationModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="locationModal.classList.remove('open')">✖</button>
      <h3 data-translate="locationTitle">Lokasyon Ayarla</h3>
      
      <div style="margin: 10px 0;">
        <label data-translate="country">Ülke:</label>
        <input id="countryInput" placeholder="Ülke ara..." style="width: 100%; padding: 8px; margin: 5px 0;" autocomplete="off"/>
        <div id="countryDropdown" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; display: none; position: absolute; background: white; z-index: 1000; width: 100%;"></div>
      </div>
      
      <div style="margin: 10px 0;">
        <label data-translate="city">Şehir:</label>
        <input id="cityInput" placeholder="Şehir ara..." style="width: 100%; padding: 8px; margin: 5px 0;" autocomplete="off"/>
        <div id="cityDropdown" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; display: none; position: absolute; background: white; z-index: 1000; width: 100%;"></div>
      </div>
      
      <div class="section">
        <button id="saveLocation" data-translate="saveBtn">Kaydet</button>
        <button onclick="locationModal.classList.remove('open')" data-translate="cancelBtn">İptal</button>
      </div>
    </div>
  </div>

  <!-- 👤 Profil Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="profileModal.classList.remove('open')">✖</button>
      <h3>Profil Düzenle</h3>
      <input id="nickname" placeholder="Nickname (benzersiz)" maxlength="20"/>
      <input id="firstName" placeholder="İsim"/>
      <input id="lastName" placeholder="Soyisim"/>
      <select id="gender">
        <option value="">Cinsiyet</option>
        <option value="erkek">Erkek</option>
        <option value="kadın">Kadın</option>
      </select>
      <input id="birth" placeholder="Doğum Tarihi"/>
      <input id="country" placeholder="Ülke"/>
      <input id="city" placeholder="Şehir"/>
      <button id="saveProfile">Kaydet</button>
      <div class="muted">Cinsiyete göre avatar otomatik ayarlanır (👨 / 👩).</div>
      <div class="section">
        <button type="button" id="btnHobbies">İlgi Alanları</button>
      </div>
    </div>
  </div>

  <!-- 🎯 Kanal Oluşturma Modal -->
  <div id="createChannelModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="createChannelModal.classList.remove('open')">✖</button>
      <h3 data-translate="createChannelTitle">Kanal Oluştur</h3>
      
      <input id="channelName" placeholder="#kanal-adı" maxlength="20" style="width: 100%; margin: 5px 0; padding: 8px;"/>
      
      <div style="margin: 10px 0;">
        <label>
          <input type="radio" name="channelType" value="public" checked>
          <span data-translate="publicChannel">🌐 Public (Herkes girebilir)</span>
        </label>
      </div>
      
      <div style="margin: 10px 0;">
        <label>
          <input type="radio" name="channelType" value="private">
          <span data-translate="privateChannel">🔒 Private (Şifre gerekli)</span>
        </label>
      </div>
      
      <div id="passwordSection" style="margin: 10px 0; display: none;">
        <input id="channelPassword" type="password" placeholder="Şifre" style="width: 100%; margin: 5px 0; padding: 8px;"/>
      </div>
      
      <div class="section">
        <button id="createChannelBtn" data-translate="createBtn">Oluştur</button>
        <button onclick="createChannelModal.classList.remove('open')" data-translate="cancelBtn">İptal</button>
      </div>
    </div>
  </div>

  <!-- 🎯 Hobiler Modal -->
  <div id="hobbyModal" class="modal">
    <div class="modal-content" style="max-height:70vh;overflow:auto">
      <button onclick="hobbyModal.classList.remove('open')" class="modal-close">✖</button>
      <h3 data-translate="hobbiesTitle">İlgi Alanları</h3>
      <div id="hobbyList"></div>
      <div style="margin-top:8px">
        <b data-translate="selectedHobbies">Seçilenler:</b>
        <div id="hobbyPicked"></div>
      </div>
      <button id="saveHobbies" data-translate="saveHobbies">Kaydet</button>
      <div class="muted" data-translate="hobbiesHint">Seçtiklerine göre önerilen kanallar otomatik eklenecek.</div>
    </div>
  </div>

  <!-- 💡 Öneri / Feedback Modal -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="feedbackModal.classList.remove('open')">✖</button>
      <h3>Öneri Gönder</h3>
      <textarea id="feedbackText" placeholder="Önerini / isteğini yaz..."
        style="width:60vw;max-width:600px;height:120px"></textarea>
      <div class="section">
        <button id="sendFeedback">Gönder</button>
      </div>
      <div class="muted">Teşekkürler! Düşünceleriniz geliştirmemize yardımcı olur.</div>
    </div>
  </div>

  <!-- Çok dilli destek -->
  <script src="translations.js"></script>
  
  <!-- app.js (mevcut mantığın) -->
  <script src="app.js"></script>
  
  <!-- Yeni özellikler -->
  <script src="advanced-features.js"></script>
  

  
  <!-- Kanal Sistemi -->
  <script src="channel-system.js"></script>

  <!-- === İnce ayar: giriş & profil & hobiler davranışı + yatay hobby chips === -->
  <script>
    // Mobil menü
    function toggleMobileMenu(force){
      const el=document.getElementById("mobileMenu");
      if(!el) return;
      if(force===false){el.classList.remove("open");return;}
      el.classList.toggle("open");
    }

    // app.js bazen "hobbiesModal" ismini arıyor; aynı modala işaret etsin:
    window.hobbiesModal = document.getElementById('hobbyModal');
    window.hobbyModal = document.getElementById('hobbyModal');

    // Giriş butonuna basınca: Sadece login modalı aç
    const btnLogin = document.getElementById('btnLogin');
    const loginModal = document.getElementById('loginModal');
    if(btnLogin && loginModal){
      btnLogin.onclick = ()=>{
        loginModal.classList.add('open');
      };
    }

    // Profil butonu (giriş yaptıysa app.js zaten görünür yapıyor, burada sadece modal açıyoruz)
    const btnProfile = document.getElementById('btnProfile');
    const profileModal = document.getElementById('profileModal');
    if(btnProfile && profileModal){
      btnProfile.onclick = ()=> profileModal.classList.add('open');
    }

    // HOBİLER: Yatay chips + “+” ile kaybolsun -> seçilenlere eklensin
    const ALL_HOBBIES_FALLBACK = [
      "Futbol","Basketbol","Voleybol","Koşu","Fitness","Yüzme","Tenis","MMA","Dalış","Kamp",
      "Bilgisayar Oyunları","Mobil Oyunlar","CS:GO","LoL","Valorant","Satranç",
      "Film","Dizi","Netflix","Anime","Belgesel",
      "Müzik","Rock","Rap","Klasik","Piyano","Gitar","DJ",
      "Kitap","Roman","Şiir","Kişisel Gelişim","Felsefe",
      "Yemek","Tatlı","Kahve","Çay","Barbekü","Vegan",
      "Teknoloji","Yazılım","Yapay Zekâ","Siber Güvenlik","Kripto",
      "Seyahat","Fotoğraf","Doğa","Resim","Heykel","Tasarım","Moda",
      "Araba","Motosiklet","Drone","RC","Model",
      "Dil Öğrenme","İngilizce","Almanca","İspanyolca","Türkçe",
      "Girişimcilik","Pazarlama","E-ticaret","Yatırım","Borsa",
      "Sağlık","Psikoloji","Meditasyon","Yoga","Mindfulness"
    ];

    function getAllHobbies(){
      // app.js içinden ALL_HOBBIES varsa onu kullan, yoksa fallback
      return (window.ALL_HOBBIES && Array.isArray(window.ALL_HOBBIES) ? window.ALL_HOBBIES : ALL_HOBBIES_FALLBACK).slice();
    }
    function getPickedSet(){
      try{
        const arr = JSON.parse(localStorage.getItem('hobbies')||'[]');
        return new Set(arr);
      }catch{ return new Set(); }
    }
    function savePickedSet(set){
      localStorage.setItem('hobbies', JSON.stringify([...set]));
    }

    function renderHobbyChips(){
      const list = document.getElementById('hobbyList');
      const pickedWrap = document.getElementById('hobbyPicked');
      if(!list || !pickedWrap) return;

      const picked = getPickedSet();
      list.innerHTML = "";
      pickedWrap.innerHTML = "";

      // Seçilenleri üstte rozet gibi göster
      [...picked].forEach(h=>{
        const chip=document.createElement('div');
        chip.className='picked-chip';
        chip.textContent=h;
        pickedWrap.appendChild(chip);
      });

      // Seçilmemiş (gösterilecek) hobiler
      const all = getAllHobbies();
      const remaining = all.filter(h=>!picked.has(h));

      remaining.forEach(h=>{
        const chip=document.createElement('div');
        chip.className='hobby-chip';
        chip.innerHTML = `<span>${h}</span>`;
        const plus=document.createElement('button');
        plus.textContent = "+";
        plus.title = "Ekle";
        plus.onclick = ()=>{
          picked.add(h);
          savePickedSet(picked);
          // anında listeden kaybolsun:
          chip.remove();
          // seçilenlere rozeti ekle
          const sel=document.createElement('div');
          sel.className='picked-chip';
          sel.textContent=h;
          pickedWrap.appendChild(sel);
        };
        chip.appendChild(plus);
        list.appendChild(chip);
      });
    }

    // “İlgi Alanları” butonu da bu yeni yatay görünüme açsın
    const btnHobbies = document.getElementById('btnHobbies');
    if(btnHobbies){
      btnHobbies.onclick = ()=>{
        hobbyModal.classList.add('open');
        renderHobbyChips();
      };
    }

    // Kaydet -> localStorage'a yazıldı ve backend'e gönderildi
    const saveHobbiesBtn = document.getElementById('saveHobbies');
    if(saveHobbiesBtn){
      saveHobbiesBtn.onclick = async ()=>{
        const hobbies = Array.from(picked);
        localStorage.setItem('hobbies', JSON.stringify(hobbies));
        
        // Backend'e gönder
        try {
          const response = await fetch('https://chat-backend-xi60.onrender.com/profile/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              token: localStorage.getItem('token'),
              profile: { hobbies: hobbies }
            })
          });
          
          if (response.ok) {
            alert("İlgi alanları kaydedildi.");
            // Önerilen kanalları yükle
            if (window.smartChannelSystem) {
              window.smartChannelSystem.userHobbies = hobbies;
              window.smartChannelSystem.loadSuggestedChannels();
            }
            // Kanal sistemini güncelle
            if (window.channelSystem) {
              window.channelSystem.updateHobbies(hobbies);
            }
            // Event tetikle
            window.dispatchEvent(new CustomEvent('hobbiesSaved', { detail: { hobbies } }));
          }
        } catch (error) {
          console.error('İlgi alanları kaydedilemedi:', error);
          alert("İlgi alanları kaydedildi (yerel olarak).");
        }
        
        hobbyModal.classList.remove('open');
        
        // Sayfayı yenileme - sadece kanalları güncelle
        console.log('✅ İlgi alanları kaydedildi, sayfa yenilenmeyecek');
      };
    }
  </script>
</body>
</html>